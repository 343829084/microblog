var mongodb = require('./db');

function Publish(userName, vistorInfo) {
    this.userName = userName;
    this.vistorInfo = vistorInfo;
}

module.exports = Publish;

Publish.prototype.Save = function Save(callback) {
    var vistorInfo = {
        name: this.vistorInfo.name,
        annual_yield: this.vistorInfo.annual_yield,
        deadline: this.vistorInfo.deadline,
        process: this.vistorInfo.process,
        money: this.vistorInfo.money,
        replay_way: this.vistorInfo.replay_way,
        date: this.vistorInfo.date,
        status: this.vistorInfo.status
    }

    mongodb.open(function(err, db) {
        if(err) {
            return callback(err);
        }
        db.collection('publish', function(err, collection) {
            if (err) {
                mongodb.close();
                return callback(err);
            }
            collection.ensureIndex('name', function(err) {
                if(err) {
                    return callback(err);
                }
            });
            collection.insert(vistorInfo, {safe:true}, function(err, vistorInfo) {
                mongodb.close()
                return callback(err, vistorInfo);
            });
        });
    });
}

Publish.Get = function Get(name, callback) {
    mongodb.open(function(err, db) {
        if (err) {
            return callback(err);
        }
        db.collection('publish', function(err, collection) {
            if (err) {
                mongodb.close();
                return callback(err);
            }
            var query = {};
            if (name) {
                query.name = name;
            }
            collection.find(query).toArray(function(err, docs){
                mongodb.close();
                if (err) {
                    return callback(err);
                }
                var publishs = [];
                docs.forEach(function(doc, index) {
                    var item = new Publish(name, doc);
                    publishs.push(item);
                });
                callback(null, publishs);
            });
        });
    });
}